---
import BaseLayout from '../layouts/BaseLayout.astro';
import ArticleCard from '../components/ArticleCard.astro';
import NewsletterSignup from '../components/NewsletterSignup.astro';
import { getArticles, getCategoriesWithCounts } from '../lib/supabase';
import type { Article } from '../lib/database.types';

// Fetch articles from Supabase
let articles: Article[] = [];
let featuredArticle: Article | null = null;
let categories: { category: string; count: number }[] = [];

try {
  const [featuredResults, recentResults, cats] = await Promise.all([
    getArticles({ featured: true, limit: 1 }),
    getArticles({ limit: 7 }),
    getCategoriesWithCounts(),
  ]);
  featuredArticle = featuredResults[0] || null;
  articles = recentResults.filter((a) => a.id !== featuredArticle?.id).slice(0, 6);
  categories = cats;
} catch (error) {
  console.error('Error fetching articles:', error);
}

const totalArticles = categories.reduce((sum, c) => sum + c.count, 0);

const categoryInfo: Record<string, { icon: string; description: string }> = {
  research: {
    icon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="w-5 h-5"><path d="M9.5 2A2.5 2.5 0 0112 4.5v15a2.5 2.5 0 01-4.96.44M14.5 2A2.5 2.5 0 0012 4.5v15a2.5 2.5 0 004.96.44"/><path d="M5.5 8H12m-6.5 4H12m-6.5 4H12"/></svg>`,
    description: 'Breakthroughs and discoveries'
  },
  business: {
    icon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="w-5 h-5"><path d="M3 21h18M9 8h1m-1 4h1m4-4h1m-1 4h1M5 21V5a2 2 0 012-2h10a2 2 0 012 2v16"/></svg>`,
    description: 'Industry news and partnerships'
  },
  products: {
    icon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="w-5 h-5"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v3"/></svg>`,
    description: 'Applications and releases'
  },
  investment: {
    icon: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="w-5 h-5"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 100 7h5a3.5 3.5 0 110 7H6"/></svg>`,
    description: 'Funding and market trends'
  },
};
---

<BaseLayout title="Graphene Pulse - The Definitive Source for Graphene Industry News">
  <!-- Hero Section -->
  <section class="relative overflow-hidden border-b border-border">
    <!-- Hexagon Pattern Background -->
    <div class="absolute inset-0 opacity-[0.02] pointer-events-none">
      <svg class="w-full h-full" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <pattern id="hero-hex" width="50" height="43.4" patternUnits="userSpaceOnUse" patternTransform="scale(3)">
            <polygon
              fill="none"
              stroke="currentColor"
              stroke-width="0.5"
              points="24.8,22 37.3,29.2 37.3,43.7 24.8,50.9 12.3,43.7 12.3,29.2"
              transform="translate(-12,-22)"
            />
          </pattern>
        </defs>
        <rect width="100%" height="100%" fill="url(#hero-hex)" />
      </svg>
    </div>

    <div class="relative max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-20 md:py-28">
      <div class="max-w-3xl">
        <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-border bg-bg-surface/50 text-xs font-medium text-text-muted uppercase tracking-wider mb-6">
          <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
          Live Updates
        </div>
        <h1 class="text-4xl md:text-6xl font-bold text-white mb-6 tracking-tight leading-[1.1]">
          Graphene Pulse
        </h1>
        <p class="text-xl md:text-2xl text-text-secondary mb-10 leading-relaxed max-w-2xl">
          The definitive source for graphene industry news, research breakthroughs, and market intelligence.
        </p>
        <div class="flex flex-col sm:flex-row gap-4">
          <a
            href="/news"
            class="inline-flex items-center justify-center gap-2 px-6 py-3.5 bg-white font-semibold rounded-lg hover:bg-silver-light transition-colors"
            style="color: #000000;"
          >
            <span>Browse News</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
            </svg>
          </a>
          <a
            href="/wiki"
            class="inline-flex items-center justify-center gap-2 px-6 py-3.5 border border-border-light text-white font-medium rounded-lg hover:bg-bg-surface hover:border-silver-dark transition-colors"
          >
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
            </svg>
            <span>Explore Wiki</span>
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Stats Bar -->
  <section class="border-b border-border bg-bg-surface/30">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8">
      <div class="grid grid-cols-2 md:grid-cols-4 gap-px">
        <div class="bg-bg-primary px-6 py-5 text-center">
          <div class="text-2xl md:text-3xl font-bold text-white font-mono">{totalArticles}</div>
          <div class="text-text-muted text-xs uppercase tracking-wider mt-1">Articles</div>
        </div>
        <div class="bg-bg-primary px-6 py-5 text-center">
          <div class="text-2xl md:text-3xl font-bold text-white font-mono">{categories.length}</div>
          <div class="text-text-muted text-xs uppercase tracking-wider mt-1">Categories</div>
        </div>
        <div class="bg-bg-primary px-6 py-5 text-center">
          <div class="text-2xl md:text-3xl font-bold text-white font-mono">9</div>
          <div class="text-text-muted text-xs uppercase tracking-wider mt-1">Wiki Pages</div>
        </div>
        <div class="bg-bg-primary px-6 py-5 text-center">
          <div class="text-2xl md:text-3xl font-bold text-white font-mono">Weekly</div>
          <div class="text-text-muted text-xs uppercase tracking-wider mt-1">Newsletter</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Featured Article -->
  {featuredArticle && (
    <section class="border-b border-border">
      <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12 md:py-16">
        <div class="flex items-center justify-between mb-8">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-bg-surface border border-border flex items-center justify-center">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4 text-silver">
                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
              </svg>
            </div>
            <span class="text-sm font-medium text-text-muted uppercase tracking-wider">Featured</span>
          </div>
          <a href="/news" class="text-sm text-text-secondary hover:text-white transition-colors">
            View all news
          </a>
        </div>

        <a href={`/news/${featuredArticle.slug}`} class="group block">
          <article class="relative p-6 md:p-8 rounded-xl border border-border bg-gradient-to-br from-bg-surface via-bg-surface to-bg-surface-light overflow-hidden transition-all duration-300 hover:border-silver-dark hover:shadow-2xl hover:shadow-white/5">
            <div class="absolute top-0 right-0 w-64 h-64 opacity-[0.02] transform translate-x-1/3 -translate-y-1/3">
              <svg viewBox="0 0 100 100" fill="currentColor">
                <polygon points="50,0 93.3,25 93.3,75 50,100 6.7,75 6.7,25" />
              </svg>
            </div>

            <div class="relative">
              <div class="flex flex-wrap items-center gap-3 mb-4">
                {featuredArticle.category && (
                  <span class="inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium uppercase tracking-wider rounded bg-white/10 text-silver-light capitalize">
                    {featuredArticle.category}
                  </span>
                )}
                {featuredArticle.published_at && (
                  <span class="text-text-muted text-sm">
                    {new Date(featuredArticle.published_at).toLocaleDateString('en-US', {
                      month: 'long',
                      day: 'numeric',
                      year: 'numeric',
                    })}
                  </span>
                )}
              </div>

              <h2 class="text-2xl md:text-3xl font-bold text-white mb-4 group-hover:text-silver-bright transition-colors leading-tight">
                {featuredArticle.title}
              </h2>

              {featuredArticle.summary && (
                <p class="text-text-secondary text-lg mb-6 line-clamp-2 max-w-3xl">
                  {featuredArticle.summary}
                </p>
              )}

              <div class="flex items-center gap-4">
                <div class="inline-flex items-center gap-2 text-silver group-hover:text-white transition-colors">
                  <span class="font-medium">Read article</span>
                  <svg class="w-4 h-4 transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                  </svg>
                </div>
                {featuredArticle.source_name && (
                  <>
                    <span class="w-1 h-1 bg-text-muted rounded-full"></span>
                    <span class="text-text-muted text-sm">{featuredArticle.source_name}</span>
                  </>
                )}
              </div>
            </div>
          </article>
        </a>
      </div>
    </section>
  )}

  <!-- Latest News Grid -->
  <section class="border-b border-border">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12 md:py-16">
      <div class="flex items-center justify-between mb-10">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-lg bg-bg-surface border border-border flex items-center justify-center">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4 text-silver">
              <path d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V9m2 10a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
            </svg>
          </div>
          <h2 class="text-2xl font-bold text-white">Latest</h2>
        </div>
        <a href="/news" class="inline-flex items-center gap-2 text-sm text-text-secondary hover:text-white transition-colors">
          <span>View all</span>
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </a>
      </div>

      {articles.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-px bg-border rounded-xl overflow-hidden">
          {articles.map((article, index) => (
            <div class="bg-bg-primary">
              <ArticleCard article={article} index={index} />
            </div>
          ))}
        </div>
      ) : (
        <div class="text-center py-20 border border-border rounded-xl">
          <p class="text-text-secondary">No articles yet.</p>
        </div>
      )}
    </div>
  </section>

  <!-- Categories -->
  <section class="border-b border-border">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12 md:py-16">
      <div class="flex items-center gap-3 mb-10">
        <div class="w-8 h-8 rounded-lg bg-bg-surface border border-border flex items-center justify-center">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-4 h-4 text-silver">
            <path d="M4 6h16M4 10h16M4 14h16M4 18h16" />
          </svg>
        </div>
        <h2 class="text-2xl font-bold text-white">Categories</h2>
      </div>

      <div class="grid grid-cols-2 lg:grid-cols-4 gap-px bg-border rounded-xl overflow-hidden">
        {categories.map((cat) => {
          const info = categoryInfo[cat.category] || { icon: '', description: '' };
          return (
            <a
              href={`/category/${cat.category}`}
              class="group bg-bg-primary p-6 hover:bg-bg-surface transition-colors"
            >
              <div class="flex items-center gap-3 mb-3">
                <div class="w-10 h-10 rounded-lg bg-bg-surface border border-border flex items-center justify-center text-silver group-hover:text-white group-hover:border-silver-dark transition-colors">
                  <span set:html={info.icon} />
                </div>
                <span class="text-xl font-mono font-bold text-white">{cat.count}</span>
              </div>
              <h3 class="text-base font-semibold text-white group-hover:text-silver-bright transition-colors mb-1 capitalize">
                {cat.category}
              </h3>
              <p class="text-sm text-text-muted">{info.description}</p>
            </a>
          );
        })}
      </div>
    </div>
  </section>

  <!-- Wiki Preview -->
  <section class="border-b border-border">
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12 md:py-16">
      <div class="grid md:grid-cols-2 gap-12 items-center">
        <div>
          <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-border bg-bg-surface/50 text-xs font-medium text-text-muted uppercase tracking-wider mb-6">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-3.5 h-3.5">
              <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
            </svg>
            Knowledge Base
          </div>
          <h2 class="text-3xl md:text-4xl font-bold text-white mb-4 tracking-tight">
            The Graphene Wiki
          </h2>
          <p class="text-text-secondary text-lg mb-8 leading-relaxed">
            A comprehensive reference covering graphene fundamentals, production methods, market dynamics, and industrial applications.
          </p>
          <ul class="space-y-3 mb-8">
            {['Properties & characteristics', 'Production methods', 'Market overview', 'Safety & handling', 'Quality standards'].map((item) => (
              <li class="flex items-center gap-3 text-text-secondary">
                <svg class="w-4 h-4 text-silver" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                <span>{item}</span>
              </li>
            ))}
          </ul>
          <a
            href="/wiki"
            class="inline-flex items-center gap-2 text-white font-medium hover:text-silver-light transition-colors"
          >
            <span>Explore the Wiki</span>
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
            </svg>
          </a>
        </div>

        <div class="hidden md:block">
          <div class="bg-bg-surface rounded-xl p-6 border border-border font-mono text-sm">
            <div class="text-text-muted mb-4">// Graphene at a glance</div>
            <div class="space-y-3">
              <div class="flex items-center gap-2">
                <span class="text-text-muted w-24">strength</span>
                <span class="text-text-secondary">:</span>
                <span class="text-white">"200x steel"</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-text-muted w-24">conductivity</span>
                <span class="text-text-secondary">:</span>
                <span class="text-white">"best known"</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-text-muted w-24">thickness</span>
                <span class="text-text-secondary">:</span>
                <span class="text-white">"1 atom"</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-text-muted w-24">transparency</span>
                <span class="text-text-secondary">:</span>
                <span class="text-white">"97.7%"</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-text-muted w-24">discovered</span>
                <span class="text-text-secondary">:</span>
                <span class="text-white">"2004"</span>
              </div>
              <div class="flex items-center gap-2">
                <span class="text-text-muted w-24">nobel</span>
                <span class="text-text-secondary">:</span>
                <span class="text-white">"2010"</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Newsletter -->
  <section>
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12 md:py-16">
      <NewsletterSignup
        heading="Weekly Digest"
        description="Graphene news and insights delivered to your inbox every week."
      />
    </div>
  </section>
</BaseLayout>

<style>
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  .animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
