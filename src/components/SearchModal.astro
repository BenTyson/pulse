---
// Search modal component - renders hidden by default, activated via JS
---

<div id="search-modal" class="fixed inset-0 z-[100] hidden" role="dialog" aria-modal="true" aria-labelledby="search-title">
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" id="search-backdrop"></div>

  <!-- Modal -->
  <div class="relative flex items-start justify-center pt-[15vh] px-4">
    <div class="w-full max-w-2xl bg-bg-primary border border-border rounded-xl shadow-2xl overflow-hidden">
      <!-- Search Input -->
      <div class="flex items-center gap-3 px-4 py-3 border-b border-border">
        <svg class="w-5 h-5 text-text-muted flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
        </svg>
        <input
          type="text"
          id="search-input"
          placeholder="Search articles..."
          class="flex-1 bg-transparent text-white placeholder:text-text-muted outline-none text-lg"
          autocomplete="off"
          autocorrect="off"
          autocapitalize="off"
          spellcheck="false"
        />
        <kbd class="hidden sm:inline-flex items-center px-2 py-0.5 text-xs text-text-muted bg-bg-surface rounded border border-border">
          ESC
        </kbd>
      </div>

      <!-- Results -->
      <div id="search-results" class="max-h-[60vh] overflow-y-auto">
        <!-- Empty state -->
        <div id="search-empty" class="px-4 py-12 text-center text-text-muted">
          <p>Start typing to search articles</p>
        </div>

        <!-- Loading state -->
        <div id="search-loading" class="hidden px-4 py-12 text-center text-text-muted">
          <p>Searching...</p>
        </div>

        <!-- No results -->
        <div id="search-no-results" class="hidden px-4 py-12 text-center text-text-muted">
          <p>No articles found</p>
        </div>

        <!-- Results list -->
        <div id="search-results-list" class="hidden divide-y divide-border"></div>
      </div>

      <!-- Footer -->
      <div class="px-4 py-2 border-t border-border bg-bg-surface/50 flex items-center justify-between text-xs text-text-muted">
        <span>Search powered by full-text search</span>
        <div class="flex items-center gap-2">
          <span class="hidden sm:inline">Navigate:</span>
          <kbd class="hidden sm:inline-flex items-center px-1.5 py-0.5 bg-bg-surface rounded border border-border">↑</kbd>
          <kbd class="hidden sm:inline-flex items-center px-1.5 py-0.5 bg-bg-surface rounded border border-border">↓</kbd>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  const modal = document.getElementById('search-modal');
  const backdrop = document.getElementById('search-backdrop');
  const input = document.getElementById('search-input') as HTMLInputElement;
  const resultsContainer = document.getElementById('search-results-list');
  const emptyState = document.getElementById('search-empty');
  const loadingState = document.getElementById('search-loading');
  const noResultsState = document.getElementById('search-no-results');

  let debounceTimer: ReturnType<typeof setTimeout>;
  let selectedIndex = -1;
  let results: any[] = [];

  // Open modal
  function openSearch() {
    modal?.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    input?.focus();
  }

  // Close modal
  function closeSearch() {
    modal?.classList.add('hidden');
    document.body.style.overflow = '';
    if (input) input.value = '';
    resetResults();
  }

  // Reset results state
  function resetResults() {
    selectedIndex = -1;
    results = [];
    emptyState?.classList.remove('hidden');
    loadingState?.classList.add('hidden');
    noResultsState?.classList.add('hidden');
    resultsContainer?.classList.add('hidden');
    if (resultsContainer) resultsContainer.innerHTML = '';
  }

  // Perform search
  async function search(query: string) {
    if (query.length < 2) {
      resetResults();
      return;
    }

    emptyState?.classList.add('hidden');
    loadingState?.classList.remove('hidden');
    noResultsState?.classList.add('hidden');
    resultsContainer?.classList.add('hidden');

    try {
      const response = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
      const data = await response.json();

      loadingState?.classList.add('hidden');

      if (data.results && data.results.length > 0) {
        results = data.results;
        renderResults(results);
        resultsContainer?.classList.remove('hidden');
      } else {
        noResultsState?.classList.remove('hidden');
      }
    } catch (error) {
      console.error('Search error:', error);
      loadingState?.classList.add('hidden');
      noResultsState?.classList.remove('hidden');
    }
  }

  // Render results
  function renderResults(items: any[]) {
    if (!resultsContainer) return;

    resultsContainer.innerHTML = items.map((item, index) => `
      <a
        href="/news/${item.slug}"
        class="block px-4 py-3 hover:bg-bg-surface transition-colors search-result ${index === selectedIndex ? 'bg-bg-surface' : ''}"
        data-index="${index}"
      >
        <div class="flex items-start gap-3">
          <div class="flex-1 min-w-0">
            <h3 class="text-silver-bright font-medium truncate">${escapeHtml(item.title)}</h3>
            <p class="text-text-secondary text-sm mt-1 line-clamp-2">${escapeHtml(item.summary || '')}</p>
            <div class="flex items-center gap-2 mt-2 text-xs text-text-muted">
              ${item.category ? `<span class="capitalize">${item.category}</span>` : ''}
              ${item.published_at ? `<span>${formatDate(item.published_at)}</span>` : ''}
            </div>
          </div>
          <svg class="w-4 h-4 text-text-muted flex-shrink-0 mt-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
          </svg>
        </div>
      </a>
    `).join('');
  }

  // Helper functions
  function escapeHtml(text: string): string {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  }

  function formatDate(dateStr: string): string {
    return new Date(dateStr).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric',
    });
  }

  // Update selection
  function updateSelection(newIndex: number) {
    const items = resultsContainer?.querySelectorAll('.search-result');
    if (!items) return;

    items.forEach((item, i) => {
      if (i === newIndex) {
        item.classList.add('bg-bg-surface');
        item.scrollIntoView({ block: 'nearest' });
      } else {
        item.classList.remove('bg-bg-surface');
      }
    });
    selectedIndex = newIndex;
  }

  // Event listeners
  backdrop?.addEventListener('click', closeSearch);

  input?.addEventListener('input', (e) => {
    const query = (e.target as HTMLInputElement).value;
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => search(query), 200);
  });

  document.addEventListener('keydown', (e) => {
    // Cmd/Ctrl + K to open
    if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
      e.preventDefault();
      if (modal?.classList.contains('hidden')) {
        openSearch();
      } else {
        closeSearch();
      }
    }

    // ESC to close
    if (e.key === 'Escape' && !modal?.classList.contains('hidden')) {
      closeSearch();
    }

    // Arrow navigation
    if (!modal?.classList.contains('hidden') && results.length > 0) {
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        updateSelection(Math.min(selectedIndex + 1, results.length - 1));
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        updateSelection(Math.max(selectedIndex - 1, 0));
      } else if (e.key === 'Enter' && selectedIndex >= 0) {
        e.preventDefault();
        const item = resultsContainer?.querySelector(`[data-index="${selectedIndex}"]`) as HTMLAnchorElement;
        if (item) window.location.href = item.href;
      }
    }
  });

  // Expose openSearch globally for header button
  (window as any).openSearch = openSearch;
</script>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
