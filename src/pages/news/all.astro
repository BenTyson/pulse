---
import BaseLayout from '../../layouts/BaseLayout.astro';
import ArticleCard from '../../components/ArticleCard.astro';
import { getArticles, getCategoriesWithCounts } from '../../lib/supabase';
import type { Article } from '../../lib/database.types';

const url = Astro.url;
const currentPage = parseInt(url.searchParams.get('page') || '1');
const pageSize = 12;

let articles: Article[] = [];
let categories: { category: string; count: number }[] = [];
let featuredArticle: Article | null = null;

try {
  const [allArticles, cats] = await Promise.all([
    getArticles({ limit: pageSize + 1, offset: (currentPage - 1) * pageSize }),
    getCategoriesWithCounts(),
  ]);

  // On first page, pull out featured article
  if (currentPage === 1 && allArticles.length > 0) {
    const featuredIdx = allArticles.findIndex(a => a.featured);
    if (featuredIdx >= 0) {
      featuredArticle = allArticles[featuredIdx];
      articles = allArticles.filter((_, i) => i !== featuredIdx).slice(0, pageSize - 1);
    } else {
      featuredArticle = allArticles[0];
      articles = allArticles.slice(1, pageSize);
    }
  } else {
    articles = allArticles.slice(0, pageSize);
  }

  categories = cats;
} catch (error) {
  console.error('Error fetching articles:', error);
}

const totalArticles = categories.reduce((sum, c) => sum + c.count, 0);
const hasMore = articles.length === pageSize || (currentPage === 1 && articles.length === pageSize - 1);

// Category icons
const categoryIcons: Record<string, string> = {
  research: `<svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9.5 2A2.5 2.5 0 0112 4.5v15a2.5 2.5 0 01-4.96.44M14.5 2A2.5 2.5 0 0012 4.5v15a2.5 2.5 0 004.96.44"/><path d="M5.5 8H12m-6.5 4H12m-6.5 4H12"/></svg>`,
  business: `<svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18M9 8h1m-1 4h1m4-4h1m-1 4h1M5 21V5a2 2 0 012-2h10a2 2 0 012 2v16"/></svg>`,
  products: `<svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="7" width="20" height="14" rx="2"/><path d="M16 7V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v3"/></svg>`,
  investment: `<svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 100 7h5a3.5 3.5 0 110 7H6"/></svg>`,
};
---

<BaseLayout
  title="All News"
  description="All the latest news and updates from the graphene industry."
>
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12 md:py-16">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-6 mb-10">
      <div>
        <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full border border-border bg-bg-surface/50 text-xs font-medium text-text-muted uppercase tracking-wider mb-4">
          <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span>
          Live Feed
        </div>
        <h1 class="text-3xl md:text-4xl font-bold text-white mb-3">All News</h1>
        <p class="text-text-secondary text-lg max-w-xl">
          Everything happening in graphene research, business, and applications.
        </p>
      </div>

      <!-- Stats -->
      <div class="flex items-center gap-6 text-sm">
        <div class="text-center">
          <div class="text-2xl font-bold text-white font-mono">{totalArticles}</div>
          <div class="text-text-muted text-xs uppercase tracking-wider">Articles</div>
        </div>
        <div class="w-px h-10 bg-border"></div>
        <div class="text-center">
          <div class="text-2xl font-bold text-white font-mono">{categories.length}</div>
          <div class="text-text-muted text-xs uppercase tracking-wider">Categories</div>
        </div>
      </div>
    </div>

    <!-- Category Filters -->
    <div class="flex flex-wrap items-center gap-2 mb-10 pb-8 border-b border-border">
      <span class="text-xs text-text-muted uppercase tracking-wider mr-2">Filter:</span>
      <a
        href="/news/all"
        class="inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-semibold rounded-full bg-white border border-white transition-all"
        style="color: #000000 !important;"
      >
        All
        <span class="text-xs opacity-70" style="color: #000000;">
          {totalArticles}
        </span>
      </a>
      {categories.map((cat) => (
        <a
          href={`/category/${cat.category}`}
          class="group inline-flex items-center gap-1.5 px-3 py-1.5 text-sm font-medium rounded-full border border-border text-text-secondary hover:border-silver-dark hover:text-white hover:bg-bg-surface transition-all capitalize"
        >
          <span class="opacity-50 group-hover:opacity-100 transition-opacity" set:html={categoryIcons[cat.category] || ''} />
          {cat.category}
          <span class="text-xs opacity-50">{cat.count}</span>
        </a>
      ))}
    </div>

    <!-- Featured Article (Page 1 only) -->
    {currentPage === 1 && featuredArticle && (
      <a href={`/news/${featuredArticle.slug}`} class="group block mb-10">
        <article class="relative p-6 md:p-8 rounded-xl border border-border bg-gradient-to-br from-bg-surface via-bg-surface to-bg-surface-light overflow-hidden transition-all duration-300 hover:border-silver-dark hover:shadow-2xl hover:shadow-white/5">
          <div class="absolute top-0 right-0 w-64 h-64 opacity-[0.02] transform translate-x-1/3 -translate-y-1/3">
            <svg viewBox="0 0 100 100" fill="currentColor">
              <polygon points="50,0 93.3,25 93.3,75 50,100 6.7,75 6.7,25" />
            </svg>
          </div>

          <div class="relative">
            <div class="flex flex-wrap items-center gap-3 mb-4">
              {featuredArticle.category && (
                <span class="inline-flex items-center gap-1.5 px-2.5 py-1 text-xs font-medium uppercase tracking-wider rounded bg-white/10 text-silver-light capitalize">
                  <span set:html={categoryIcons[featuredArticle.category] || ''} />
                  {featuredArticle.category}
                </span>
              )}
              {featuredArticle.published_at && (
                <span class="text-text-muted text-sm">
                  {new Date(featuredArticle.published_at).toLocaleDateString('en-US', {
                    month: 'long',
                    day: 'numeric',
                    year: 'numeric',
                  })}
                </span>
              )}
              <span class="px-2 py-0.5 text-xs font-medium uppercase tracking-wider rounded bg-silver-dark/20 text-silver">
                Featured
              </span>
            </div>

            <h2 class="text-2xl md:text-3xl font-bold text-white mb-4 group-hover:text-silver-bright transition-colors leading-tight">
              {featuredArticle.title}
            </h2>

            {featuredArticle.summary && (
              <p class="text-text-secondary text-lg mb-6 line-clamp-2 max-w-3xl">
                {featuredArticle.summary}
              </p>
            )}

            <div class="flex items-center gap-4">
              <div class="inline-flex items-center gap-2 text-silver group-hover:text-white transition-colors">
                <span class="font-medium">Read article</span>
                <svg class="w-4 h-4 transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8l4 4m0 0l-4 4m4-4H3" />
                </svg>
              </div>
              {featuredArticle.source_name && (
                <>
                  <span class="w-1 h-1 bg-text-muted rounded-full"></span>
                  <span class="text-text-muted text-sm">{featuredArticle.source_name}</span>
                </>
              )}
            </div>
          </div>
        </article>
      </a>
    )}

    <!-- Articles Grid -->
    {articles.length > 0 ? (
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-px bg-border rounded-xl overflow-hidden mb-12">
        {articles.map((article, index) => (
          <div class="bg-bg-primary">
            <ArticleCard article={article} index={index} />
          </div>
        ))}
      </div>
    ) : (
      <div class="text-center py-24 border border-border rounded-xl bg-bg-surface/30">
        <div class="w-12 h-12 mx-auto mb-4 rounded-full bg-bg-surface flex items-center justify-center">
          <svg class="w-6 h-6 text-text-muted" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V9m2 10a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
          </svg>
        </div>
        <h2 class="text-xl font-semibold text-white mb-2">No articles yet</h2>
        <p class="text-text-secondary">Check back soon for the latest graphene news.</p>
      </div>
    )}

    <!-- Pagination -->
    {(currentPage > 1 || hasMore) && (
      <div class="flex items-center justify-between">
        <div>
          {currentPage > 1 ? (
            <a
              href={`/news/all?page=${currentPage - 1}`}
              class="group inline-flex items-center gap-2 px-4 py-2.5 border border-border text-text-secondary rounded-lg hover:border-silver-dark hover:text-white hover:bg-bg-surface transition-all text-sm font-medium"
            >
              <svg class="w-4 h-4 transform group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
              </svg>
              Previous
            </a>
          ) : <div />}
        </div>

        <div class="flex items-center gap-2">
          <span class="w-9 h-9 flex items-center justify-center text-sm font-medium text-white bg-white/10 rounded-lg">{currentPage}</span>
          {hasMore && (
            <a href={`/news/all?page=${currentPage + 1}`} class="w-9 h-9 flex items-center justify-center text-sm text-text-muted hover:text-white hover:bg-bg-surface rounded-lg transition-all">{currentPage + 1}</a>
          )}
        </div>

        <div>
          {hasMore ? (
            <a
              href={`/news/all?page=${currentPage + 1}`}
              class="group inline-flex items-center gap-2 px-4 py-2.5 border border-border text-text-secondary rounded-lg hover:border-silver-dark hover:text-white hover:bg-bg-surface transition-all text-sm font-medium"
            >
              Next
              <svg class="w-4 h-4 transform group-hover:translate-x-1 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
              </svg>
            </a>
          ) : <div />}
        </div>
      </div>
    )}
  </div>
</BaseLayout>

<style>
  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  .animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }

  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>
