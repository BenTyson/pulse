---
import type { Article } from '../lib/database.types';

interface Props {
  article: Article;
  featured?: boolean;
  index?: number;
}

const { article, featured = false, index = 0 } = Astro.props;

const formattedDate = article.published_at
  ? new Date(article.published_at).toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
    })
  : null;

// Calculate relative time
const getRelativeTime = (date: string) => {
  const now = new Date();
  const published = new Date(date);
  const diffMs = now.getTime() - published.getTime();
  const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

  if (diffHours < 24) {
    return diffHours <= 1 ? '1h ago' : `${diffHours}h ago`;
  } else if (diffDays < 7) {
    return diffDays === 1 ? '1d ago' : `${diffDays}d ago`;
  }
  return null;
};

const relativeTime = article.published_at ? getRelativeTime(article.published_at) : null;
const isRecent = relativeTime && (relativeTime.includes('h') || relativeTime === '1d ago');

// Category styling
const categoryColors: Record<string, string> = {
  research: 'bg-blue-500/10 text-blue-400 border-blue-500/20',
  business: 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20',
  products: 'bg-purple-500/10 text-purple-400 border-purple-500/20',
  investment: 'bg-amber-500/10 text-amber-400 border-amber-500/20',
};

const categoryStyle = article.category
  ? categoryColors[article.category] || 'bg-white/5 text-silver border-border'
  : 'bg-white/5 text-silver border-border';
---

<article
  class:list={[
    'group relative h-full transition-all duration-200',
    'hover:bg-bg-surface',
    featured ? 'md:col-span-2 md:row-span-2' : '',
  ]}
>
  <a href={`/news/${article.slug}`} class="flex flex-col h-full p-6">
    <!-- Top Row: Category & Time -->
    <div class="flex items-center justify-between gap-3 mb-4">
      <div class="flex items-center gap-2">
        {article.category && (
          <span class:list={[
            'inline-flex items-center px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wider rounded border',
            categoryStyle
          ]}>
            {article.category}
          </span>
        )}
        {isRecent && (
          <span class="flex items-center gap-1 text-[10px] font-medium text-green-400 uppercase tracking-wider">
            <span class="w-1 h-1 rounded-full bg-green-400 animate-pulse"></span>
            New
          </span>
        )}
      </div>
      {relativeTime ? (
        <span class="text-text-muted text-xs font-medium">{relativeTime}</span>
      ) : formattedDate && (
        <span class="text-text-muted text-xs">{formattedDate}</span>
      )}
    </div>

    <!-- Title -->
    <h3
      class:list={[
        'font-semibold text-silver-bright group-hover:text-white transition-colors mb-3 leading-snug',
        featured ? 'text-xl md:text-2xl line-clamp-3' : 'text-[15px] line-clamp-2',
      ]}
    >
      {article.title}
    </h3>

    <!-- Summary -->
    {article.summary && (
      <p
        class:list={[
          'text-text-secondary flex-1 mb-4',
          featured ? 'text-base line-clamp-4' : 'text-sm line-clamp-2',
        ]}
      >
        {article.summary}
      </p>
    )}

    <!-- Footer -->
    <div class="flex items-center justify-between mt-auto pt-4 border-t border-border/50">
      <div class="flex items-center gap-2 text-xs text-text-muted">
        {article.source_name && (
          <span class="truncate max-w-[120px]">{article.source_name}</span>
        )}
      </div>
      <span class="flex items-center gap-1 text-xs text-silver-dark group-hover:text-silver transition-colors">
        Read
        <svg class="w-3 h-3 transform group-hover:translate-x-0.5 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
        </svg>
      </span>
    </div>

    <!-- Importance indicator (subtle) -->
    {article.importance_score && article.importance_score >= 8 && (
      <div class="absolute top-3 right-3 w-2 h-2 rounded-full bg-silver-dark" title="High importance"></div>
    )}
  </a>
</article>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-4 {
    display: -webkit-box;
    -webkit-line-clamp: 4;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.4; }
  }

  .animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }
</style>
